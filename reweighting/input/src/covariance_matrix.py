import numpy as np
from numpy.linalg import inv
from pprint import pprint

atlas_vals = np.array([[12.27, 11.57, 10.41, 9.09, 6.85],
                        [11.87, 11.55, 10.09, 8.6, 6.25],
                        [12.18, 11.77, 10.61, 8.85, 7.22],
                        [12.52, 12.14, 10.29, 8.38, 6.55]])

A = np.zeros(5)
B = np.zeros(5)

for eta_lept_index in range(5):
    A[eta_lept_index] = atlas_vals[1][eta_lept_index] + atlas_vals[3][eta_lept_index]
    B[eta_lept_index] = atlas_vals[0][eta_lept_index] + atlas_vals[2][eta_lept_index]

eta_starless = np.array([[0.201, 0.183, 0.184, 0.126, 0.115, 0.193, 0.178, 0.179, 0.121, 0.154],
                        [0.245, 0.229, 0.219, 0.165, 0.129, 0.237, 0.221, 0.212, 0.206, 0.121],
                        [0.390, 0.349, 0.367, 0.223, 0.194, 0.376, 0.340, 0.402, 0.212, 0.179],
                        [0.385, 0.396, 0.352, 0.236, 0.208, 0.375, 0.431, 0.340, 0.221, 0.178],
                        [0.425, 0.392, 0.388, 0.249, 0.216, 0.463, 0.375, 0.376, 0.237, 0.193],
                        [0.222, 0.215, 0.206, 0.142, 0.180, 0.216, 0.208, 0.194, 0.129, 0.115],
                        [0.259, 0.243, 0.233, 0.221, 0.142, 0.249, 0.236, 0.223, 0.165, 0.126],
                        [0.401, 0.363, 0.435, 0.233, 0.206, 0.388, 0.352, 0.367, 0.219, 0.184],
                        [0.398, 0.457, 0.363, 0.243, 0.215, 0.392, 0.396, 0.349, 0.229, 0.183],
                        [0.490, 0.398, 0.401, 0.259, 0.222, 0.425, 0.385, 0.390, 0.245, 0.201]])

eta_star = np.array([[0.0733, 0.129, 0.166, 0.0941, 0.0854, 0.0782, 0.138, 0.156, 0.0875, 0.168],
                    [0.109, 0.156, 0.174, 0.129, 0.0951, 0.118, 0.164, 0.167, 0.192, 0.0875],
                    [0.0898, 0.255, 0.359, 0.180, 0.169, 0.105, 0.267, 0.423, 0.167, 0.156],
                    [0.154, 0.261, 0.281, 0.176, 0.146, 0.170, 0.352, 0.267, 0.164, 0.138],
                    [0.197, 0.161, 0.107, 0.131, 0.0805, 0.296, 0.170, 0.105, 0.118, 0.0782],
                    [0.0778, 0.139, 0.179, 0.100, 0.177, 0.0805, 0.146, 0.169, 0.0951, 0.0854],
                    [0.116, 0.172, 0.187, 0.212, 0.100, 0.131, 0.176, 0.180, 0.129, 0.0941],
                    [0.0992, 0.268, 0.458, 0.187, 0.179, 0.107, 0.281, 0.359, 0.174, 0.166],
                    [0.145, 0.323, 0.268, 0.172, 0.139, 0.161, 0.261, 0.255, 0.156, 0.129],
                    [0.273, 0.145, 0.0992, 0.116, 0.0778, 0.197, 0.154, 0.0898, 0.109, 0.0733]])

pT_starless = np.array([[0.0169, 0.0360, 0.0476, 0.0203, 0.00417, 0.0196, 0.0335, 0.0466, 0.0180, 0.00782],
                        [0.0889, 0.171, 0.215, 0.0951, 0.0190, 0.0916, 0.160, 0.210, 0.0989, 0.0180],
                        [0.197, 0.597, 0.783, 0.232, 0.0486, 0.196, 0.566, 0.804, 0.210, 0.0466],
                        [0.305, 0.565, 0.593, 0.181, 0.0341, 0.279, 0.619, 0.566, 0.160, 0.0335],
                        [0.495, 0.298, 0.201, 0.110, 0.0164, 0.615, 0.279, 0.196, 0.0916, 0.0196],
                        [0.0142, 0.0370, 0.0493, 0.0207, 0.00853, 0.0164, 0.0341, 0.0486, 0.0190, 0.00417],
                        [0.105, 0.190, 0.236, 0.119, 0.0207, 0.110, 0.181, 0.232, 0.0951, 0.0203],
                        [0.203, 0.622, 0.864, 0.236, 0.0493, 0.201, 0.593, 0.783, 0.215, 0.0476],
                        [0.313, 0.664, 0.622, 0.190, 0.0370, 0.298, 0.565, 0.597, 0.171, 0.0360],
                        [0.645, 0.313, 0.203, 0.105, 0.0142, 0.495, 0.305, 0.197, 0.0889, 0.0169]])

pT_star = np.array([[0.0262, 0.0289, 0.0265, 0.0126, 0.00452, 0.0262, 0.0302, 0.0253, 0.0112, 0.0115],
                    [0.00164, 0.0229, 0.167, 0.0765, 0.0148, 0.000730, 0.0301, 0.158, 0.0999, 0.0112],
                    [0.0606, 0.0991, 0.414, 0.172, 0.0277, 0.0486, 0.115, 0.495, 0.158, 0.0253],
                    [0.507, 0.483, 0.108, 0.0346, 0.0357, 0.485, 0.612, 0.115, 0.0301, 0.0302],
                    [0.561, 0.490, 0.0464, 0.00176, 0.0295, 0.727, 0.485, 0.0486, 0.000730, 0.0262],
                    [0.0297, 0.0339, 0.0315, 0.0149, 0.0144, 0.0295, 0.0357, 0.0277, 0.0148, 0.00452],
                    [0.00149, 0.0261, 0.177, 0.106, 0.0149, 0.00176, 0.0346, 0.172, 0.0765, 0.0126],
                    [0.0470, 0.0975, 0.492, 0.177, 0.0315, 0.0464, 0.108, 0.414, 0.167, 0.0265],
                    [0.508, 0.584, 0.0975, 0.0261, 0.0339, 0.490, 0.483, 0.0991, 0.0229, 0.0289],
                    [0.818, 0.508, 0.0470, 0.00149, 0.0297, 0.561, 0.507, 0.0606, 0.00164, 0.0262]])

eta_starless = np.flipud(eta_starless)
eta_star = np.flipud(eta_star)
pT_starless = np.flipud(pT_starless)
pT_star = np.flipud(pT_star)

Rcpm_derivatives = np.array([[-A[0] / B[0]**2, 0., 0., 0., 0., 1. / B[0], 0., 0., 0., 0., -A[0] / B[0]**2, 0., 0., 0., 0., 1. / B[0], 0., 0., 0., 0.],
                            [0., -A[1] / B[1]**2, 0., 0., 0., 0., 1. / B[1], 0., 0., 0., 0., -A[1] / B[1]**2, 0., 0., 0., 0., 1. / B[1], 0., 0., 0.],
                            [0., 0., -A[2] / B[2]**2, 0., 0., 0., 0., 1. / B[2], 0., 0., 0., 0., -A[2] / B[2]**2, 0., 0., 0., 0., 1. / B[2], 0., 0.],
                            [0., 0., 0., -A[3] / B[3]**2, 0., 0., 0., 0., 1. / B[3], 0., 0., 0., 0., -A[3] / B[3]**2, 0., 0., 0., 0., 1. / B[3], 0.],
                            [0., 0., 0., 0., -A[4] / B[4]**2, 0., 0., 0., 0., 1. / B[4], 0., 0., 0., 0., -A[4] / B[4]**2, 0., 0., 0., 0., 1. / B[4]]])


def cov_Rcpm(starless, star, filename):
    cov_exp = np.zeros((20, 20))

    for i in range(10):
        for j in range(10):
            cov_exp[i, j] = starless[i, j]
            cov_exp[10 + i, 10 + j] = star[i, j]

    cov_Rcpm = Rcpm_derivatives @ cov_exp @ Rcpm_derivatives.T

    cov_Rcpm_inv = inv(cov_Rcpm)

    Rcpm_errors = np.zeros(5)

    for i in range(5):
        Rcpm_errors[i] = np.sqrt(cov_Rcpm[i, i])

    np.savetxt('exp_errors/' + filename + '.txt', Rcpm_errors)
    np.savetxt('covariance_matrix/' + filename + '.txt', cov_Rcpm_inv)

    #for row in cov_Rcpm_inv:
    #    print(" ".join(f"{val:4}" for val in row))
    #print()


cov_Rcpm(eta_starless, eta_star, 'eta_lept')
cov_Rcpm(pT_starless, pT_star, 'pTD')



